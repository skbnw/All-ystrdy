headline,mainEntityOfPage,image,datePublished,dateModified,author,media_en,media_jp,str_count,body,images,external_links
【第67回】Ubuntu上でIntelのNPUを活用した画像を生成するまで（PC Watch）,https://news.yahoo.co.jp/articles/a2a8a90032cba15ff4e86fb77010be5dd02f8506,https://newsatcl-pctr.c.yimg.jp/t/amd-img/20250118-00000014-imppcw-000-1-view.jpg?exp=10800,2025-01-18T06:20:26+09:00,2025-01-18T06:20:26+09:00,PC Watch,imppcw,PC Watch,3517,"写真：PC Watch
第58回でRyzen AIをUbuntuで動作させる方法を紹介した。AMDでやったのであればIntelでもやりたいと考えるのが人情というもので、IntelのNPUである「Intel AI Boost」を搭載したPCないしCPUを購入しようと狙っていたものの、その機会はなかなか訪れなかった。
【画像】UEFI BIOSアップデート後のシステム詳細
そんな中、本連載担当の劉デスクから「Core UltraにせっかくNPUが付いてるのでLLMや画像生成を動かしてみた！ミニPC「UH125 Pro」」の記事でで紹介されたUH125 Proが送られてきた。

　UH125 Proはすでに終売していて、採用しているCore Ultra 5 125Hもリリースされてから1年以上経過しているので、Ubuntuも難なく動作するものと予想していたが、なかなか一筋縄ではいかなかった。ただし動いてしまえば、Ubuntuの機能で環境構築が極めて簡単であった。

　なお、UH125 Proの概要については省略する。前出のレビュー記事を参照されたい。

■ UH125 Proとファームウェア

　UH125 ProのUEFI BIOSのバージョンが古かったので(レビュー試供品なので当然なのだが)、第57回を参考にUEFIシェルからアップデートを実行しようとした。しかしUEFIシェルが起動しなかったので、Windowsを再インストールしてそこからアップデートを実行した。

　あとから考えてみると、セキュアブートを有効にしている場合はUEFIシェルが起動しないのは自然な挙動である。早とちりして膨大な時間を無駄にしてしまった。

■ UH125 ProとUbuntu 24.04.1 LTS

　UH125 Proで動作させるUbuntuのバージョンを何にするかはちょっと迷ったが、24.04.1 LTSを選択した。24.04.1のカーネル6.8でも最低限動作するものと予想していたが、Wi-Fiは認識するもののNICは認識しなかった。それはまだいいのだが、ランダムでカーネルパニックを引き起こしており、対応していないカーネルの典型的な挙動と見ていい。

　インストールが終わったら、マウスポインタの消失が頻発したので、何だこれと思ってディスプレイの設定を見てみたら、存在しないディスプレイが接続されていてちょっとしたホラーだった。

　時期的にはそろそろlinux-image-generic-hwe-22.04かlinux-image-generic-hwe-22.04-edgeで24.10のカーネルである6.11が提供されてもよさそうに思えるが、執筆段階では未提供だったので、linux-image-oem-24.04bをインストールして検証した。こちらは現段階で6.11になっている。

　正直なところ、UH125 ProでUbuntuを使用するのであれば、3月にはリリースされるであろう24.04.2 LTSを待ったほうがいい。

■ 5GbE NIC

　UH125 Proには5GbE NICが搭載されている。10GbEや2.5GbEはよく聞くが、5GbEはあまり聞かない。NICがあっても5GbE対応スイッチングハブは聞いたことがなく、活躍する場面があるのか疑問がある。2.5GbEでよかったのではないだろうか。そんなことを考えつつlspciコマンドで調べてみたところ、どうもRTL8126というNICのようだ。

　速度を測定する方法はないものかと思案してみたところ、第64回で試した10GbEが使用できそうだった。実戦投入はできなかったものの、検証環境として使い道があるならそれはそれで買ってよかったというものである。

　第64回とほぼ同じ方法でiperf3の結果を見てみたところ、4.71Gb/sとのことで、おおむね5GbEの能力を引き出せることが分かった。

　Sambaで10GiBファイル転送も試してみたところ、530,575.3KB/sということで、これをGb/sに変換すると4.244とのことで、やはり5GbEの能力を発揮していることが分かった。

　しかしやはり宝の持ち腐れ感が否めない。いつか活躍できる機会を期待したいものである。

■ NPUドライバのインストール

　第58回で紹介したRyzen APUのNPUドライバはインストールが面倒だった。ではIntelではどうなのかというと、CanonicalがIntel NPUドライバのsnapパッケージを用意しているので、端末から次のコマンドを実行するだけであった(Discorseの該当記事)。

$ sudo snap install --beta intel-npu-driver

　intel-npu-driver.vpu-umd-testコマンドを実行してみたところ、181のテストのうち失敗したのが1つだけであり、ベータ版のドライバであるにもかかわらずおおむね問題なく動作していることが分かる。

■ NPUドライバを使用する

　Ryzen AIであれば、この段階で活躍するところがないということで締めくくっており、記事のオチとしてもなかなかに傑作であった。一方こちらはさすがのIntel、きちんと活躍する方法を用意している。

　前出のレビュー記事でも登場したOpenVINO AI Plugins for GIMPは、実はUbuntuでも動作するのだ。このプラグインを含めたGIMPがsnapパッケージになっており、Ubuntuであれば動作させるのも簡単だ。実際にやっていこう。

　まずはコマンドから必要なsnapパッケージをインストールする。もちろん前出のinte-gpu-driverをインストールしていることが前提だ。

$ sudo snap install openvino-toolkit-2404 --beta
$ sudo snap install openvino-ai-plugins-gimp --beta
$ sudo snap install gimp --channel 2.99-openvino/candidate
$ sudo usermod -a -G render $USER

　使用しているユーザーがrenderグループに属していない場合は、4行目を実行して再起動する。

　筆者が確認した限りでは、次のコマンドも追加で実行する必要があった。このあたりはインストールするバージョンによって異なる可能性もある。

$ sudo snap connect gimp:gpu-2404 mesa-2404
$ sudo snap connect gimp:gnome-46-2404 gnome-46-2404:gnome-46-2404

　起動してしまえば、使い方はWindows版のインストール方法にあるとおりではあるのだが、実際に試してみたところ少なくとも検証の段階では事前にモデルを読み込んでおく必要がある。端末からopenvino-ai-plugins-gimp.model-setupコマンドを実行する。

　NPUに使用できるモデルは1と2だけなので、それらをインストールするといいだろう。

　その後はGIMP起動後「レイヤー」-「OpenVINO-AI-Plugins」-「Stable diffusion」を表示し、使用するモデルを選択してから「Load Models」をクリックして読み込む。「Power Mode」を「Best power efficiency」または「Balanced」に変更するのがコツだ。前者だと可能な限りNPUを使用しようとする。

　ここまでできたら、あとはキーワードを入力して「Generate」をクリックするだけだ。

　これが実用的かと問われると甚だ疑問であるが、そもそもNPUの速度自体が実用的かという根本的な問題がある。今のところはこのぐらいで遊んでおいて、あとは年内にもあるであろうNPUの性能を底上げした新モデルに期待したい。

　実際に生成した画像が冒頭の画像だが、本当は蛇(今年の干支)がパソコン(PC)を見ている(Watch)画像を生成したかったところ、なかなかうまくいかなかったのでキーワードをこねくり回してこうなった。
PC Watch,Ubuntu Japanese Team あわしろいくや",[],[]
その後のDの呪縛（PC Watch）,https://news.yahoo.co.jp/articles/92df65eca539a5efb93fbd187e1b957fa0f85ae7,https://newsatcl-pctr.c.yimg.jp/t/amd-img/20250118-00000013-imppcw-000-1-view.jpg?exp=10800,2025-01-18T06:19:18+09:00,2025-01-18T06:19:18+09:00,PC Watch,imppcw,PC Watch,2912,"写真：PC Watch
新しい道具には新しい使い方が似合う。慣れ親しんだ古い使い方にこだわり続けることがいいとは限らない。頭ではそのことを分かっているのだが、カラダが言うことをきかなかったりもする。個人的に半世紀程度の付き合いという点では、道具としてのPCもカメラも似たようなものだが、使い方が変わるスピードは大きく違う。

■ 重さに負けてカメラを買い替え

　暮れに新しいカメラを買った。ニコンのミラーレスカメラZ6IIIだ。まだ本格的にはデビューさせていない。まず、道具として手になじませる必要がある。発売は2024年7月だったので、発売後半年してからの購入だ。発売日に購入しなかったニコンのデジタルカメラは初めてだ。

　Z6IIIはFX(フルサイズ)フォーマットの2,450万画素カメラでバッテリとメモリーカードを含む撮影時重量は760gだ。

　これまで使っていたメインカメラは同じニコンのデジタル一眼レフカメラでD850だった。購入は2017年だったのでちょうど7年使ったことになる。まだ現行製品でもあるし、大きな不満もなかった。画素数だって新規購入したZ6IIIより多い4,575万画素ある。

　このカメラを年末に出かけた旅行に久しぶりに持ち出して使ったのだが、撮影時重量1,005gというのはつらい。これに愛用ズームレンズのAF-S VR Zoom-Nikkor 24-120mm f/3.5-5.6G IF-EDを装着して10日ほど携行した。レンズ重量は575gあるので合計約1.6kgだ。つらかった。新製品のカメラを半年経ってから購入する気になったもっとも大きな理由だ。

　新しく入手したZ6IIIでは、2021年に入手したZ fcで常用していたレンズを同じように常用する。Z fc はグリップの形状が手になじまずに手放してしまったが、念のためにとレンズは残しておいた。

　NIKKOR Z DX 18-140mm f/3.5-6.3 VRはDXレンズなので、Z6IIIのフルサイズセンサーからAPS-Cサイズを切り出して使うことになる。焦点距離も1.5倍になるので、27-210mm相当のズームレンズとして使える。重量も315gだ。Z6IIIに装着すると合計1,075gとなり、D850携行時より3割以上もダイエットできた。それでも445gのZ fcに装着して合計760gで使っていたことを思えば重い。

■ 持ち歩いてナンボだから

　Z fcでの不満はセンサークリーニングとボディ内手ブレ補正の機能がなかったことだった。3年間使ったが、その間に撮った写真には悲しいゴミの影が見つかるものがそれなりにある。アプリを使って除去するのはやっぱり面倒だ。

　Z6IIIには、この両方がある。

　ただ、失われたものもある。たとえばこのZ6IIIにDXレンズを装着した場合、撮像範囲を16:9に設定することができない。必ず3:2になってしまうのだ。Z fcではそんなことはなく、16:9を設定できたので、スマホでもレンズ交換式カメラでも16:9画角で撮るようにしてきた。D850には16:9という撮像範囲設定はなかったので撮影気分も新鮮だった。

　だが、Z6IIIで16:9を設定できるのはフルサイズセンサー対応のFXレンズを装着したときだけだ。FXレンズはDXレンズに比べて大きく重いので、軽量化のためにカメラを新調した立場としては微妙に残念だ。ここはひとつ、ファームウェア等の更新でできるようにしてほしいものだが、フルサイズセンサーをDXレンズで使うというのはやっぱり後ろ向きなんだろうか。

　カメラとレンズの重量を気にするようになってからは、もうレンズの明るさはあまり気にならなくなった。ISO感度はD850が64～25600、Z fcは100～51200、ISO 100～64000と順調に感度が上がってきているので、一絞りや二絞りくらい明るいかどうかなんて、撮影とはあまり関係なくなっているからだ。

　バッテリにはEN-EL15c、EN-EL15b、EN-EL15aを使う。基本的にD850と共通だが、無印以降、a、b、cと世代を重ねてきた。D850に同梱されていた無印のEN-EL15は使えない。世代が変わり、EN-EL15cは容量も増えているし、何よりもUSB Power Deliveryに対応するようになった。同梱のEN-EL15cをZ6IIIに装着した状態で27W以上推奨でACアダプタやモバイルバッテリ等での充電がUSB Type-Cポートからできる。

　ニコンのカメラはUSB給電とUSB充電を明確に区別していて、カメラの電源がオンの場合に内蔵バッテリへの充電が行なわれないようにできる。つまり、内蔵バッテリが空になっても、外部に接続したモバイルバッテリなどでの駆動ができる。内蔵バッテリに充電してから、その電力を駆動に使うといった無駄がなく、一般的な30W USB PD対応モバイルバッテリがあれば電力の心配をせずにカメラを使い続けられる。

　このあたりのプロ好みの仕様決めはさすがだと思う。

　ちなみにバッテリは専用充電機MH-25aでも充電できる。愛用で予備も所有しているD850用のAC対応専用充電機だ。充電器そのものは最新型がUSB PDに対応しているが、さほど急速に充電できるわけではない。また、カメラ本体にUSB Type-Cケーブルを接続してのUSB充電ができるのは、カメラに同梱されている最新のEN-EL15cを装着している場合だけだ。

■ スマホのカメラ、カメラのカメラ

　スマホだけで取材等の撮影をまかなおうとしてみた時期もあったが、どうしてもシャッターチャンスを逃してしまうことが多かった。特に人間を被写体とする場合はカメラ専用機が便利だ。

　だが、その代償が重量となる。カメラとPCの両方を荷物として携行するわけだが、今はPCよりもカメラのほうが重い道具になってしまった。だが、カメラとPCの双方でいろんなペリフェラルを流用できるのはうれしい。充電機やモバイルバッテリなどはもちろん、Z6IIIではHDMIポートもフルサイズだ。なんでも共用できる。

　慣らしが済んだらかつて愛用した大量の重量級Fマウントレンズをどうするかを考えなくてはならない。ずっとすべてを置いておくというわけにもいかない。正直、フルサイズ対応のZマウントレンズも欲しい。

　D850では何の問題もなくオートフォーカスが使えていたFマウントのマクロレンズAI AF Micro-Nikkor 60mm f/2.8DをマウントアダプターFTZ IIを使って装着すると、AFが使えず、フォーカスエイドしかできないことに気がついた。古いレンズを使い続けるのはそろそろ潮時か。そもそもD850も処分してしまったのでもう後戻りはできない。20年以上前のレンズでも、その画質に不満があるわけではないだけに、愛用レンズとの別れはつらい……。
PC Watch,山田 祥平",[],[]
